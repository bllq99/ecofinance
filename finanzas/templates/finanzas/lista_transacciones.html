{% extends 'finanzas/base.html' %}
{% load custom_filters %}
{% block title %}Transacciones{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Mis Transacciones</h1>
    </div>

    {% if meses %}
        <div class="accordion" id="transaccionesAccordion">
            {% for mes_clave, mes_data in meses %}
                <div class="accordion-item mb-3 shadow-sm border">
                    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapse{{ forloop.counter }}" 
                                aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                                aria-controls="collapse{{ forloop.counter }}">
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <span class="fs-5 fw-semibold">{{ mes_data.nombre }}</span>
                                <div class="d-flex">
                                    <span class="badge bg-success me-2">+{{ mes_data.total_ingresos|formato_clp }}</span>
                                    <span class="badge bg-danger">-{{ mes_data.total_gastos|formato_clp }}</span>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse{{ forloop.counter }}" 
                         class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                         aria-labelledby="heading{{ forloop.counter }}" 
                         data-bs-parent="#transaccionesAccordion">
                        <div class="accordion-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-3">Fecha</th>
                                            <th class="d-none d-sm-table-cell">Descripción</th>
                                            <th class="d-none d-md-table-cell">Categoría</th>
                                            <th>Tipo</th>
                                            <th class="text-end pe-3">Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaccion in mes_data.transacciones %}
                                        <tr>
                                            <td class="ps-3">{{ transaccion.fecha|date:"d/m/Y" }}</td>
                                            <td class="d-none d-sm-table-cell">{{ transaccion.descripcion }}</td>
                                            <td class="d-none d-md-table-cell">
                                                {% if transaccion.categoria %}
                                                    {{ transaccion.categoria|capfirst }}
                                                {% else %}
                                                    <span class="text-muted">Sin categoría</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if transaccion.tipo == "INGRESO" %}
                                                    <span class="badge bg-success">Ingreso</span>
                                                    {% if transaccion.es_recurrente %}
                                                        <span class="badge bg-info ms-1">
                                                            <i class="fas fa-sync-alt"></i>
                                                        </span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-danger">Gasto</span>
                                                    {% if transaccion.es_recurrente %}
                                                        <span class="badge bg-info ms-1">
                                                            <i class="fas fa-sync-alt"></i> Recurrente
                                                        </span>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td class="text-end pe-3">
                                                {% if transaccion.tipo == "INGRESO" %}
                                                    <span class="text-success fw-bold">+{{ transaccion.monto|formato_clp }}</span>
                                                {% else %}
                                                    <span class="text-danger fw-bold">-{{ transaccion.monto|formato_clp }}</span>
                                                {% endif %}
                                                <!-- Botón de eliminar -->
                                                <button class="btn btn-sm btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteModal{{ transaccion.id }}">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <!-- Modal de confirmación -->
                                        <div class="modal fade" id="deleteModal{{ transaccion.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ transaccion.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="deleteModalLabel{{ transaccion.id }}">Confirmar eliminación</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        ¿Estás seguro de que deseas eliminar esta transacción?
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                        <form method="POST" action="{% url 'eliminar_transaccion' transaccion.id %}">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-danger">Eliminar</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <h3 class="text-muted">No hay transacciones registradas</h3>
                <p class="text-muted">Comienza a registrar tus ingresos y gastos para visualizarlos aquí</p>
                <a href="{% url 'nueva_transaccion' %}" class="btn btn-primary mt-2">
                    <i class="fas fa-plus me-2"></i>Crear mi primera transacción
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Botón flotante -->
<a href="{% url 'nueva_transaccion' %}" class="btn btn-primary btn-lg rounded-circle position-fixed" 
   style="bottom: 20px; right: 20px; z-index: 1030;">
    <i class="fas fa-plus"></i>
</a>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar que Bootstrap está disponible
        if (typeof bootstrap !== 'undefined') {
            // Inicializar todos los acordeones
            var accordionItems = document.querySelectorAll('.accordion-button');
            accordionItems.forEach(function(item) {
                item.addEventListener('click', function() {
                    var target = document.querySelector(this.dataset.bsTarget);
                    var bsCollapse = new bootstrap.Collapse(target, {
                        toggle: false
                    });
                    
                    if (this.classList.contains('collapsed')) {
                        bsCollapse.show();
                        this.classList.remove('collapsed');
                        this.setAttribute('aria-expanded', 'true');
                    } else {
                        bsCollapse.hide();
                        this.classList.add('collapsed');
                        this.setAttribute('aria-expanded', 'false');
                    }
                });
            });
        }
    });
</script>
{% endblock %}
{% endblock %}
