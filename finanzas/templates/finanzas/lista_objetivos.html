{% extends 'finanzas/base.html' %}
{% load humanize %}

{% block title %}Objetivos de Ahorro{% endblock %}

{% block extra_css %}
<style>
.progress-inline {
    width: 100px;
    height: 4px;
    vertical-align: middle;
    display: inline-block;
    margin-left: 0.5rem;
}
.progress-bar-inline {
    height: 100%;
}
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Objetivos de Ahorro</h1>

<div class="row mb-4">
    {% if objetivos_vencidos %}
    <div class="col-12">
        <div class="alert alert-danger alert-dismissible fade show py-2" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong class="me-2">¡Objetivos vencidos!</strong>
                {% for objetivo in objetivos_vencidos %}
                <span class="me-3">
                    {{ objetivo.nombre }} (vencido hace {{ objetivo.dias_vencido }} días)
                    <div class="progress progress-inline">
                        <div class="progress-bar bg-danger progress-bar-inline" role="progressbar" 
                             style="width: {{ objetivo.progreso }}%;" 
                             aria-valuenow="{{ objetivo.progreso }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                </span>
                {% endfor %}
                <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if objetivos_por_vencer %}
    <div class="col-12">
        <div class="alert alert-warning alert-dismissible fade show py-2" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong class="me-2">¡Objetivos próximos a vencer!</strong>
                {% for objetivo in objetivos_por_vencer %}
                <span class="me-3">
                    {{ objetivo.nombre }} (faltan {{ objetivo.dias_restantes }} días)
                    <div class="progress progress-inline">
                        <div class="progress-bar progress-bar-inline" role="progressbar" 
                             style="width: {{ objetivo.progreso }}%;" 
                             aria-valuenow="{{ objetivo.progreso }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                </span>
                {% endfor %}
                <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<a href="{% url 'nuevo_objetivo' %}" class="btn btn-success mb-3">➕ Nuevo Objetivo</a>

{% if objetivos %}
<div class="row">
    {% for objetivo in objetivos %}
    <div class="col-md-6 mb-4">
        <div class="card {% if objetivo.fecha_limite and objetivo.fecha_limite < fecha_actual %}border-danger{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center {% if objetivo.fecha_limite and objetivo.fecha_limite < fecha_actual %}bg-danger text-white{% endif %}">
                <span>{{ objetivo.nombre }}</span>
                {% if objetivo.fecha_limite %}
                    {% with dias_restantes=objetivo.fecha_limite|timeuntil %}
                        {% if dias_restantes == "0 días" %}
                            <span class="badge bg-danger">Vencido</span>
                        {% elif dias_restantes|slice:":2"|add:"0" <= 10 %}
                            <span class="badge bg-warning text-dark">{{ dias_restantes }}</span>
                        {% else %}
                            <span class="badge bg-info">{{ dias_restantes }}</span>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </div>
            <div class="card-body">
                <p>Monto objetivo: <strong>${{ objetivo.monto_objetivo|floatformat:0|intcomma }}</strong></p>
                <p>Monto actual: <strong>${{ objetivo.monto_actual|floatformat:0|intcomma }}</strong></p>
                <div class="progress">
                    <div class="progress-bar {% if objetivo.fecha_limite and objetivo.fecha_limite < fecha_actual %}bg-danger{% endif %} progress-bar-inline" role="progressbar"
                         style="width: {{ objetivo.progreso }}%;"
                         aria-valuenow="{{ objetivo.monto_actual }}"
                         aria-valuemin="0"
                         aria-valuemax="{{ objetivo.monto_objetivo }}">
                        {{ objetivo.progreso }}%
                    </div>
                </div>
                {% if objetivo.fecha_limite %}
                <p class="mt-2 {% if objetivo.fecha_limite < fecha_actual %}text-danger{% else %}text-muted{% endif %}">
                    Fecha límite: {{ objetivo.fecha_limite }}
                </p>
                {% endif %}
                <div class="mt-3 text-end">
                    <a href="{% url 'editar_objetivo' objetivo.id %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-edit me-1"></i>Editar
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
    <p>No hay objetivos de ahorro registrados.</p>
{% endif %}
{% endblock %}
